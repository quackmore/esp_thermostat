function update_page(){update_last_rst(),update_meminfo(),file_upload_update(),setTimeout((function(){update_fsinfo(),update_file_list()}),250)}function esp_get_last_rst(e){$.ajax({type:"GET",url:esp8266.url+"/api/debug/lastReset",dataType:"json",crossDomain:esp8266.cors,timeout:2e3,success:function(t){e(t)},error:function(e,t,a){ajax_error(e,t,a)}})}function formatStackDump(e){for(var t="",a=0;a<e.spDump.length;a++)t+=e.spDump[a],t+="\r\n";return t}function update_last_rst(){esp_get_last_rst((function(e){$("#last_rst_date").val(e.date),$("#last_rst_reason").val(e.reason),$("#last_rst_exccause").val(e.exccause),$("#last_rst_epc1").val(e.epc1),$("#last_rst_epc2").val(e.epc2),$("#last_rst_epc3").val(e.epc3),$("#last_rst_evcvaddr").val(e.evcvaddr),$("#last_rst_depc").val(e.depc),$("#last_rst_sp").val(e.sp),$("#last_rst_spdump").val(formatStackDump(e))}))}function esp_get_meminfo(e){$.ajax({type:"GET",url:esp8266.url+"/api/debug/memInfo",dataType:"json",crossDomain:esp8266.cors,timeout:2e3,success:function(t){e(t)},error:function(e,t,a){ajax_error(e,t,a)}})}function update_meminfo(){esp_get_meminfo((function(e){$("#meminfo_stack_max").val(e.stack_max_addr),$("#meminfo_stack_min").val(e.stack_min_addr),$("#meminfo_heap_start").val(e.heap_start_addr),$("#meminfo_heap_free").val(e.heap_free_size),$("#meminfo_heap_max_size").val(e.heap_max_size),$("#meminfo_heap_min_size").val(e.heap_min_size),$("#meminfo_heap_objs").val(e.heap_objs),$("#meminfo_heap_max_objs").val(e.heap_max_objs)}))}function esp_get_fsinfo(e){$.ajax({type:"GET",url:esp8266.url+"/api/fs",dataType:"json",crossDomain:esp8266.cors,timeout:2e3,success:function(t){e(t)},error:function(e,t,a){ajax_error(e,t,a)}})}function update_fsinfo(){esp_get_fsinfo((function(e){$("#fsinfo_size").val(e.file_system_size),$("#fsinfo_used").val(e.file_system_used_size)}))}function esp_get_file(e){$.ajax({type:"GET",url:esp8266.url+"/api/file",dataType:"json",crossDomain:esp8266.cors,timeout:2e3,success:function(t){e(t)},error:function(e,t,a){ajax_error(e,t,a)}})}function update_file_list(){esp_get_file((function(e){e.files.sort((function(e,t){var a=e.name.toUpperCase(),s=t.name.toUpperCase();return a<s?-1:a>s?1:0}));for(var t="",a=0;a<e.files.length;a++)t+='<div class="row no-gutters"><span class="my-auto float-left">',t+=e.files[a].name,t+='</span><div class="btn-group my-auto ml-auto" role="group"><span class="my-auto">',t+=e.files[a].size,t+='</span><button class="btn" onclick="file_show(\'',t+=e.files[a].name,t+="',",t+=e.files[a].size,t+=');"><i class="fa fa-file-o"></i></button><button class="btn" onclick="file_del(\'',t+=e.files[a].name,t+='\');"><i class="fa fa-trash"></i></button></div></div>';$("#file_list").html(t)}))}function file_show(e,t){$("#awaiting").modal("show");var a=t/8+3e3;console.log(a),$.ajax({type:"GET",url:esp8266.url+"/api/file/"+e,crossDomain:esp8266.cors,timeout:a,success:function(t){setTimeout((function(){$("#awaiting").modal("hide")}),1e3),$("#file_name").text(e),$("#file_content").val(t),$("#file_modal").modal("show")},error:function(e,t,a){setTimeout((function(){$("#awaiting").modal("hide")}),1e3),ajax_error(e,t,a)}})}function file_del(e){confirm("Deleted files cannot be recovered.\nConfirm delete...")&&$.ajax({type:"DELETE",url:esp8266.url+"/api/file/"+e,crossDomain:esp8266.cors,timeout:2e3,success:function(e){update_file_list()},error:function(e,t,a){ajax_error(e,t,a),update_file_list()}})}function file_upload_update(){$("#file_upload").prop("disabled",!0)}function upload_remaining(e,t){var a;a=e.length-t<1500?e.length:t+1500,$.ajax({type:"PUT",url:esp8266.url+"/api/file/"+$("#file_choose").val().split("\\").pop(),contentType:"application/octet-stream",data:e.slice(t,a),processData:!1,crossDomain:esp8266.cors,timeout:2e3,success:function(a){e.length-t<1500?(setTimeout((function(){$("#awaiting").modal("hide")}),1e3),update_file_list()):upload_remaining(e,t+1500)},error:function(e,t,a){ajax_error(e,t,a),setTimeout((function(){$("#awaiting").modal("hide")}),1e3),update_file_list()}})}function esp_get_memhexdump(e){$.ajax({type:"POST",url:esp8266.url+"/api/debug/hexMemDump",dataType:"json",contentType:"application/json",data:JSON.stringify({address:$("#memhexdump_start_addr").val(),length:Number($("#memhexdump_length").val())}),crossDomain:esp8266.cors,timeout:2e3,success:function(t){e(t)},error:function(e,t,a){ajax_error(e,t,a)}})}function format_hex(e){$("#sample_text").removeClass("d-none");var t=document.getElementById("memhexdump_content").offsetWidth,a=document.getElementById("sample_text").offsetWidth,s=Math.floor((t-30-a)/(12*a/10));$("#sample_text").addClass("d-none"),e+=" ";for(var o=$("#memhexdump_start_addr").val().substr(-8).toUpperCase()+"| ",n=1,i=e.indexOf(" ",n),r=0;i>=0;)o+=("00"+e.substr(n,i-n)).substr(-2),n=i+1,i=e.indexOf(" ",n),(r+=1)%(4*s)==0?(o+="\r\n",o+=(parseInt($("#memhexdump_start_addr").val(),16)+r).toString(16).toUpperCase()+"| ",word16_len=0):o+=" ";return o}function format_chars(e){$("#sample_text").removeClass("d-none");var t=document.getElementById("memhexdump_content").offsetWidth,a=document.getElementById("sample_text").offsetWidth,s=Math.floor((t-30-a)/(8*a/10));$("#sample_text").addClass("d-none"),e+=" ";for(var o,n=$("#memhexdump_start_addr").val().substr(-8).toUpperCase()+"| ",i=1,r=e.indexOf(" ",i),l=0;r>=0;)o=e.substr(i,r-i),(parseInt(o,16)<=31||parseInt(o,16)>=127)&&(o="2E"),n+=String.fromCharCode(parseInt(o,16)),i=r+1,r=e.indexOf(" ",i),(l+=1)%(8*s)==0&&(n+="\r\n",n+=(parseInt($("#memhexdump_start_addr").val(),16)+l).toString(16).toUpperCase()+"| ");return n}function update_memhexdump(){esp_get_memhexdump((function(e){1==$("#memhexdump_format").val()?$("#memhexdump_content").val(format_chars(e.content)):$("#memhexdump_content").val(format_hex(e.content))}))}$(document).ready((function(){setTimeout((function(){$("#awaiting").modal("hide")}),1e3),update_page()})),$("#reboot").on("click",(function(){confirm("Confirm device reboot...")&&$.ajax({type:"POST",url:esp8266.url+"/api/reboot",dataType:"json",crossDomain:esp8266.cors,timeout:2e3,success:function(e){alert(""+e.msg)},error:function(e,t,a){ajax_error(e,t,a)}})})),$("#last_rst_refresh").on("click",(function(e){update_last_rst()})),$("#meminfo_refresh").on("click",(function(e){update_meminfo()})),$("#fsinfo_refresh").on("click",(function(){update_fsinfo()})),$("#fs_format").on("click",(function(){confirm("File system content will be lost.\nConfirm format...")&&$.ajax({type:"POST",url:esp8266.url+"/api/fs/format",dataType:"json",crossDomain:esp8266.cors,timeout:2e3,success:function(e){alert(""+e.msg)},error:function(e,t,a){ajax_error(e,t,a)}})})),$("#file_refresh").on("click",(function(){update_file_list()})),$("#file_choose").on("change",(function(){var e=$(this).val().split("\\").pop();$(this).siblings(".custom-file-label").addClass("selected").html(e),e?$("#file_upload").prop("disabled",!1):$("#file_upload").prop("disabled",!0)})),$("#file_upload").on("click",(function(){var e=$("#file_choose").prop("files")[0],t=new FileReader;t.readAsArrayBuffer(e),t.onload=function(){$("#awaiting").modal("show");var e,a=new Uint8Array(t.result);e=a.length<1500?a.length:1500,$.ajax({type:"POST",url:esp8266.url+"/api/file/"+$("#file_choose").val().split("\\").pop(),contentType:"application/octet-stream",data:a.slice(0,e),processData:!1,crossDomain:esp8266.cors,timeout:2e3,success:function(e){a.length<1500?(setTimeout((function(){$("#awaiting").modal("hide")}),1e3),update_file_list()):upload_remaining(a,1500)},error:function(e,t,a){ajax_error(e,t,a),setTimeout((function(){$("#awaiting").modal("hide")}),1e3),update_file_list()}})}})),$("#memhexdump_start_addr").on("change",(function(){$("#memhexdump_start_addr").val($("#memhexdump_start_addr").val().toUpperCase())})),$("#memhexdump_length").on("change",(function(){$("#memhexdump_length").val()<4&&$("#memhexdump_length").val(4),$("#memhexdump_length").val()>1024&&$("#memhexdump_length").val(1024)})),$("#memhexdump_refresh").on("click",(function(){update_memhexdump()}));