function update_page(){update_program_list(),setTimeout((function(){update_advCtrlSettings(),update_rLogSettings()}),200),setTimeout((function(){update_programs()}),400)}function esp_get_prg_list(t){$.ajax({type:"GET",url:esp8266.url+"/api/ctrl/program",dataType:"json",crossDomain:esp8266.cors,timeout:2e3,success:function(r){t(r)},error:function(t,r,e){ajax_error(t,r,e)}})}function esp_get_ctrl_settings(t){$.ajax({type:"GET",url:esp8266.url+"/api/ctrl/settings",dataType:"json",crossDomain:esp8266.cors,timeout:2e3,success:function(r){t(r)},error:function(t,r,e){ajax_error(t,r,e)}})}function ctrlSettings(){var t=new Object;return t.ctrl_mode=parseInt($("#sett_ctrl_mode").val()),0==$("#sett_manual").val()?t.manual_pulse_on=0:t.manual_pulse_on=parseInt($("#sett_man_on").val()),t.manual_pulse_off=parseInt($("#sett_man_off").val()),t.auto_setpoint=10*parseFloat($("#sett_auto_sp").val()),$("#sett_prg_name").val()?t.program_id=parseInt($("#sett_prg_name").val()):t.program_id=0,0==$("#sett_off_timer_en").val()?t.power_off_timer=0:t.power_off_timer=parseInt($("#sett_off_timer").val()),t}function update_program_list(){esp_get_prg_list((function(t){$("#sett_prg_name").empty().append((function(){for(var r=t.prg_count,e="",a=0;a<r;a++)e+='<option value="'+t.prg_headings[a].id+'">'+t.prg_headings[a].desc+"</option>";return e})),update_settings()}))}function refresh_settings_view(){0==$("#sett_ctrl_mode").val()&&($("#manual_settings").addClass("d-none"),$("#manual_settings_timers").addClass("d-none"),$("#sett_auto").addClass("d-none"),$("#sett_prg").addClass("d-none"),$("#sett_pwr_off").addClass("d-none")),1==$("#sett_ctrl_mode").val()&&($("#manual_settings").removeClass("d-none"),0==$("#sett_manual").val()?$("#manual_settings_timers").addClass("d-none"):$("#manual_settings_timers").removeClass("d-none"),$("#sett_auto").addClass("d-none"),$("#sett_prg").addClass("d-none"),$("#sett_pwr_off").removeClass("d-none"),0==$("#sett_off_timer_en").val()?$("#sett_off_timer").attr("readonly",!0):$("#sett_off_timer").attr("readonly",!1)),2==$("#sett_ctrl_mode").val()&&($("#manual_settings").addClass("d-none"),$("#manual_settings_timers").addClass("d-none"),$("#sett_auto").removeClass("d-none"),$("#sett_prg").addClass("d-none"),$("#sett_pwr_off").removeClass("d-none"),0==$("#sett_off_timer_en").val()?$("#sett_off_timer").attr("readonly",!0):$("#sett_off_timer").attr("readonly",!1)),3==$("#sett_ctrl_mode").val()&&($("#manual_settings").addClass("d-none"),$("#manual_settings_timers").addClass("d-none"),$("#sett_auto").addClass("d-none"),$("#sett_prg").removeClass("d-none"),$("#sett_pwr_off").addClass("d-none"))}function update_settings(t){esp_get_ctrl_settings((function(t){$("#sett_ctrl_mode").val(t.ctrl_mode),0==t.manual_pulse_on?$("#sett_manual").val(0):$("#sett_manual").val(1),$("#sett_man_on").val(t.manual_pulse_on),$("#sett_man_off").val(t.manual_pulse_off),$("#sett_auto_sp").val((t.auto_setpoint/10).toFixed(1)),$("#sett_prg_name").val(t.program_id),0==t.pwr_off_timer?$("#sett_off_timer_en").val(0):$("#sett_off_timer_en").val(1),$("#sett_off_timer").val(t.pwr_off_timer),refresh_settings_view()}))}function jsonify_settings(){var t=new Object;return t.ctrl_mode=parseInt($("#sett_ctrl_mode").val()),0==$("#sett_manual").val()?t.manual_pulse_on=0:t.manual_pulse_on=parseInt($("#sett_man_on").val()),t.manual_pulse_off=parseInt($("#sett_man_off").val()),t.auto_setpoint=10*parseFloat($("#setpoint").val()),$("#sett_prg_name").val()?t.program_id=parseInt($("#sett_prg_name").val()):t.program_id=0,0==$("#sett_off_timer_en").val()?t.pwr_off_timer=0:t.pwr_off_timer=parseInt($("#sett_off_timer").val()),t}function esp_get_ctrl_adv_settings(t){$.ajax({type:"GET",url:esp8266.url+"/api/ctrl/advSettings",dataType:"json",crossDomain:esp8266.cors,timeout:2e3,success:function(r){t(r)},error:function(t,r,e){ajax_error(t,r,e)}})}function update_advCtrlSettings(){esp_get_ctrl_adv_settings((function(t){$("#adv_sett_kp").val(t.kp),$("#adv_sett_kd").val(t.kd),$("#adv_sett_ki").val(t.ki),$("#adv_sett_u_max").val(t.u_max),$("#adv_sett_heater_on_min").val(t.heater_on_min),$("#adv_sett_heater_on_max").val(t.heater_on_max),$("#adv_sett_heater_on_off").val(t.heater_on_off),$("#adv_sett_heater_cold").val(t.heater_cold),$("#adv_sett_warm_up_period").val(t.warm_up_period),$("#adv_sett_wup_heater_on").val(t.wup_heater_on),$("#adv_sett_wup_heater_off").val(t.wup_heater_off)}))}function jsonify_advCtrlSettings(){var t=new Object;return t.kp=parseInt($("#adv_sett_kp").val()),t.kd=parseInt($("#adv_sett_kd").val()),t.ki=parseInt($("#adv_sett_ki").val()),t.u_max=parseInt($("#adv_sett_u_max").val()),t.heater_on_min=parseInt($("#adv_sett_heater_on_min").val()),t.heater_on_max=parseInt($("#adv_sett_heater_on_max").val()),t.heater_on_off=parseInt($("#adv_sett_heater_on_off").val()),t.heater_cold=parseInt($("#adv_sett_heater_cold").val()),t.warm_up_period=parseInt($("#adv_sett_warm_up_period").val()),t.wup_heater_on=parseInt($("#adv_sett_wup_heater_on").val()),t.wup_heater_off=parseInt($("#adv_sett_wup_heater_off").val()),t}function esp_get_rl_settings(t){$.ajax({type:"GET",url:esp8266.url+"/api/ctrl/remoteLog",dataType:"json",crossDomain:esp8266.cors,timeout:2e3,success:function(r){t(r)},error:function(t,r,e){ajax_error(t,r,e)}})}function update_rLogSettings(){esp_get_rl_settings((function(t){0==t.enabled?$("#rl_enabled").val(0):$("#rl_enabled").val(1),$("#rl_host").val(t.host),$("#rl_port").val(t.port),$("#rl_path").val(t.path)}))}function jsonify_rLogSettings(){var t=new Object;return t.enabled=parseInt($("#rl_enabled").val()),t.host=$("#rl_host").val(),t.port=parseInt($("#rl_port").val()),t.path=$("#rl_path").val(),t}$(document).ready((function(){setTimeout((function(){$("#awaiting").modal("hide")}),1e3),update_page()})),$("#sett_off_timer").change((function(){$("#sett_off_timer").val(Math.floor($("#sett_off_timer").val()))})),$("#sett_man_on").change((function(){$("#sett_man_on").val(Math.floor($("#sett_man_on").val()))})),$("#sett_man_off").change((function(){$("#sett_man_off").val(Math.floor($("#sett_man_off").val()))})),$("#sett_ctrl_mode").change((function(){refresh_settings_view()})),$("#sett_manual").change((function(){refresh_settings_view()})),$("#sett_off_timer_en").change((function(){refresh_settings_view()})),$("#sett_refresh").click((function(){update_program_list()})),$("#sett_save").click((function(){$("#sett_prg_name").val()||3!=parseInt($("#sett_ctrl_mode").val())?$.ajax({type:"POST",url:esp8266.url+"/api/ctrl/settings",dataType:"json",contentType:"application/json",data:JSON.stringify(ctrlSettings()),crossDomain:esp8266.cors,timeout:2e3,success:function(){alert("Settings saved.")},error:function(t,r,e){ajax_error(t,r,e)}}):alert("Cannot save null program...")})),$("#adv_sett_refresh").click((function(){update_advCtrlSettings()})),$("#adv_sett_save").click((function(){$.ajax({type:"POST",url:esp8266.url+"/api/ctrl/advSettings",dataType:"json",contentType:"application/json",data:JSON.stringify(jsonify_advCtrlSettings()),crossDomain:esp8266.cors,timeout:2e3,success:function(){alert("Settings saved.")},error:function(t,r,e){ajax_error(t,r,e)}})})),$("#rl_sett_refresh").click((function(){update_rLogSettings()})),$("#rl_sett_save").click((function(){$.ajax({type:"POST",url:esp8266.url+"/api/ctrl/remoteLog",dataType:"json",contentType:"application/json",data:JSON.stringify(jsonify_rLogSettings()),crossDomain:esp8266.cors,timeout:2e3,success:function(){alert("Settings saved.")},error:function(t,r,e){ajax_error(t,r,e)}})})),$("#programs_refresh").click((function(){update_programs()}));var program_id=-1;$("#programs_new").click((function(){program_id=-1,$("#programModalTitle").text("New program"),load_program_modal(-1)}));var prg_headings=[];function update_programs(){esp_get_prg_list((function(t){prg_headings=t.prg_headings,$("#programs_table").empty(),$("#programs_table").append('<thead><tr><th scope="col">Program</th><th scope="col" style="width:20%;">Actions</th></tr></thead><tbody>');for(var r=0;r<t.prg_headings.length;r++)$("#programs_table").append("<tr><td>"+t.prg_headings[r].desc+'</td><td><button class="btn btn-sm" onclick="modify_program('+t.prg_headings[r].id+')"><i class="fa fa-pencil-square-o"></i></button><button class="btn btn-sm" onclick="delete_program('+t.prg_headings[r].id+')"><i class="fa fa-trash-o"></i></button></td></tr>');$("#programs_table").append("</tbody>")}))}function get_program_name(t){for(var r=0;r<prg_headings.length;r++)if(prg_headings[r].id==t)return prg_headings[r].desc;return"Unknown program"}function modify_program(t){$("#programModalTitle").text(get_program_name(t)),program_id=t,load_program_modal(t)}function esp_del_program(t){$.ajax({type:"DELETE",url:esp8266.url+"/api/ctrl/program/"+t,dataType:"json",crossDomain:esp8266.cors,timeout:5e3,success:function(t){alert(t.msg),update_program_list(),update_programs()},error:function(t,r,e){ajax_error(t,r,e)}})}function delete_program(t){confirm("Deleted programs cannot be recovered.\nConfirm delete...")&&esp_del_program(t)}var curr_program=new Object;function esp_get_program(t){$.ajax({type:"GET",url:esp8266.url+"/api/ctrl/program/"+t,dataType:"json",crossDomain:esp8266.cors,timeout:2e3,success:function(r){(curr_program=r).name=get_program_name(t),update_program_modal(!1)},error:function(t,r,e){ajax_error(t,r,e)}})}function esp_post_program(){$.ajax({type:"POST",url:esp8266.url+"/api/ctrl/program",dataType:"json",data:JSON.stringify(curr_program),crossDomain:esp8266.cors,timeout:5e3+100*curr_program.periods,success:function(t){alert(t.msg),update_program_list(),update_programs(),$("#programModal").modal("hide")},error:function(t,r,e){ajax_error(t,r,e)}})}function esp_put_program(t){$.ajax({type:"PUT",url:esp8266.url+"/api/ctrl/program/"+t,dataType:"json",data:JSON.stringify(curr_program),crossDomain:esp8266.cors,timeout:5e3+100*curr_program.periods,success:function(t){alert(t.msg),update_program_list(),update_programs()},error:function(t,r,e){ajax_error(t,r,e)}})}function update_program_modal(t){t?($("#program_name").val(""),$("#program_def_sp").val((0).toFixed(1))):($("#program_name").val(curr_program.name),$("#program_def_sp").val((curr_program.min_temp/10).toFixed(1))),$("#periods_table").empty(),$("#periods_table").append('<thead><tr class="text-center"><th scope="col"> </th><th scope="col">Day</th><th scope="col">Start</th><th scope="col">End</th><th scope="col">Setpoint</th><th scope="col"></th></tr></thead><tbody>');var r=0;if(!t){for(;r<curr_program.periods.length;)$("#periods_table").append('<tr><td><button type="button-sm" class="btn btn-default" onclick="add_prg_period('+r+');"><i class="fa fa-plus-circle" aria-hidden="true"></i></button></td><td><select class="custom-select-sm" id="wk_day_'+r+'" onchange="update_wd_period('+r+');"><option value="0"> <option value="1">Mon</option><option value="2">Tue</option><option value="3">Wed</option><option value="4">Thu</option><option value="5">Fri</option><option value="6">Sat</option><option value="7">Sun</option><option value="8">All</option></select></td><td><input id="start_'+r+'" value="" class="form-control-sm text-center" style="width:5rem"data-default="00:00" onmousedown="$(\'#start_'+r+'\').clockpicker({autoclose: true});" onchange="update_start_period('+r+'); " readonly></td><td><input id="end_'+r+'" value="" class="form-control-sm text-center" style="width: 5rem" data-default="00:00" onmousedown="$(\'#end_'+r+'\').clockpicker({autoclose: true});" onchange = "update_end_period('+r+');" readonly></td><td><input type="number" min="0" max="99" step="0.1" placeholder="°C" class="form-control-sm  text-center" id="sp_'+r+'" onchange="update_sp_period('+r+');"></td><td><button type="button-sm" class="btn btn-default" onclick="del_prg_period('+r+');"><i class="fa fa-trash" aria-hidden="true"></i></button></td></tr>'),r+=1;for(r=0;r<curr_program.periods.length;){var e="#wk_day_"+r;curr_program.periods[r].wd&&$(e).val(curr_program.periods[r].wd);var a="#start_"+r;curr_program.periods[r].b&&$(a).val(("00"+Math.floor(curr_program.periods[r].b/60)).slice(-2)+":"+("00"+curr_program.periods[r].b%60).slice(-2));var o="#end_"+r;curr_program.periods[r].e&&$(o).val(("00"+Math.floor(curr_program.periods[r].e/60)).slice(-2)+":"+("00"+curr_program.periods[r].e%60).slice(-2)),$("#sp_"+r).val((curr_program.periods[r].sp/10).toFixed(1)),r+=1}}$("#periods_table").append('<tr><td><button type="button-sm" class="btn btn-default" onclick="add_prg_period('+r+')"><i class="fa fa-plus-circle" aria-hidden="true"></i></button></td><td></td><td></td><td></td><td></td><td></td></tr></tbody>'),$("#programModal").modal("show")}function load_program_modal(t){t>=0?esp_get_program(t):(curr_program={id:-1,name:"",min_temp:0,period_count:0,periods:[]},update_program_modal(!0))}function add_prg_period(t){for(var r={id:curr_program.id,name:curr_program.name,min_temp:curr_program.min_temp,period_count:curr_program.period_count+1,periods:[]},e=new Object,a=0;a<t;a++)r.periods[a]=curr_program.periods[a];r.periods.push(e);for(a=t;a<curr_program.periods.length;a++)r.periods[a+1]=curr_program.periods[a];curr_program=r,update_program_modal(!1)}function update_wd_period(t){var r="#wk_day_"+t;curr_program.periods[t].wd=parseInt($(r).val())}function update_start_period(t){var r="#start_"+t;curr_program.periods[t].b=60*parseInt($(r).val().slice(0,2))+parseInt($(r).val().slice(-2))}function update_end_period(t){var r="#end_"+t;curr_program.periods[t].e=60*parseInt($(r).val().slice(0,2))+parseInt($(r).val().slice(-2))}function update_sp_period(t){var r="#sp_"+t;$(r).val((Math.floor(10*$(r).val())/10).toFixed(1)),curr_program.periods[t].sp=10*$(r).val()}function del_prg_period(t){for(var r={id:curr_program.id,name:curr_program.name,min_temp:curr_program.min_temp,period_count:curr_program.period_count-1,periods:[]},e=0;e<t;e++)r.periods[e]=curr_program.periods[e];for(e=t+1;e<curr_program.periods.length;e++)r.periods[e-1]=curr_program.periods[e];curr_program=r,update_program_modal(!1)}$("#program_name").on("change",(function(){curr_program.name=$("#program_name").val()})),$("#program_def_sp").on("change",(function(){var t=Math.floor(10*$("#program_def_sp").val());curr_program.min_temp=t,$("#program_def_sp").val((t/10).toFixed(1))})),$("#off_timer").change((function(){$("#off_timer").val(Math.floor($("#off_timer").val()))})),$("#commandModalReset").on("click",(function(){load_program_modal(program_id)})),$("#commandModalSave").on("click",(function(){var t=!1;""==curr_program.name&&(t=!0);for(var r=0;r<curr_program.periods.length;r++)"wd"in curr_program.periods[r]&&null!=curr_program.periods[r].wd||(t=!0),"b"in curr_program.periods[r]&&null!=curr_program.periods[r].b||(t=!0),"e"in curr_program.periods[r]&&null!=curr_program.periods[r].e||(t=!0),"sp"in curr_program.periods[r]&&null!=curr_program.periods[r].sp||(t=!0);if(t)alert("There are empty fields...");else if(-1==program_id){var e=!1;for(r=0;r<prg_headings.length;r++)prg_headings[r].desc==$("#program_name").val()&&(e=!0);if(e)return void alert("Program name already in use...");esp_post_program()}else{e=!1;if($("#program_list option").each((function(t,r){r.text==$("#sel_prg_name").val()&&r.value!=curr_program.id&&(e=!0)})),e)return void alert("Program name already in use...");esp_put_program(program_id)}}));